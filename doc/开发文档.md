# 概述
guardian项目的所有业务模块开发完全基于JDK的服务提供者框架（Service Provider Interface），guardian模块开发者只需要遵循JDK的服务提供者框架规范，
可以任意的增加子模块,实现自己需要的相应的业务功能。所有的模块加载工作由guardian框架完成，模块开发者不需要关心其细节。

guardian项目最核心、最基础、必备的模块为代理转发模块（proxy），该模块为默认加载的。
假定为了实现grpc的代理转发，需要添加http2模块；为了实现ssl加密传输，需要开启ssl模块。其模块的加载顺序变为：
ssl -> http2 -> proxy。为什么是按照如此的顺序呢？因为我们的实际业务本身就是如此要求的，先经过ssl，然后经过http2模块实现与client端交互、http2帧解析，
最后到proxy模块转发到server端，实现最基础的代理转发功能。

如果需要新增一个业务模块(moduleA)，那么其模块的加载顺序看起来应该为：

```ssl -> http2 -> moduleA -> proxy```

moduleA必须放在http2模块后，因为moduleA模块必须知道header帧内容是什么，然后才能做相关的业务处理。

如果需要新增三个业务模块moduleA、moduleB、moduleC，moduleA、moduleB、moduleC的具体顺序必须由业务开发人员定义。

# guardian模块开发


所有的guardian插件模块都必须实现GuardianModule接口

```java
public interface GuardianModule {
    // 设置配置
    void setGuardianContainer(ConnectionPools connectionPools, ProxyContainer proxyContainer);

    // 是否激活该ChannelHandler
    boolean isActivate();

    // 获取ChannelHandler
    ChannelHandler getChannelHandler(SocketChannel socketChannel);
}
```

其开发步骤如下：
1. 确定业务模块在guardian项目中的加载顺序，并配置文件（starter模块中resources/guardian.yml）中添加该模块
2. 新增业务模块
（1）编写业务处理的handler，该handler可以是netty的任何一种ChannelHandler的实现类；
（2）编写GuardianModule的实现类；
（3）编写从配置文件中获取的配置选项类；
 (4) 在resorces/META-INF/services目录中添加com.test.guardian.core.GuardianModule文件，文件中的内容为GuardianModule的实现类的完整类路径；

# 举例
比如，我们需要开发http2模块,其步骤如下：
1. 添加guardian-http2模块
 (1) 编写业务处理的handler

 (2) 编写GuardianModule的实现类Http2Module

```java
public class Http2Module implements GuardianModule{
    private Http2Option http2Option;
    @Override
    public void setGuardianContainer(ConnectionPools connectionPools, ProxyContainer proxyContainer) {
        // 获取http2模块的配置参数
        http2Option = proxyContainer.get(Http2Option.class);
    }

    @Override
    public boolean isActivate() {
        // 是否激活
        return !http2Option.isHttp();
    }

    @Override
    public ChannelHandler getChannelHandler(SocketChannel socketChannel) {
        // 设置本模块的业务处理hander
        return new Http2FrameCodec(true);
    }
}
```
（3）配置文件类Http2Option
```
public class Http2Option {
    private boolean http;

    public boolean isHttp() {
        return http;
    }

    public void setHttp(boolean http) {
        this.http = http;
    }
}

```

(4) 在resources/META-INF/services目录中添加com.test.guardian.core.GuardianModule文件, 文件中的内容为：
   ```com.test.guardian.http2.Http2Module ```

2. 在配置文件(starter模块中resources/guardian.yml)中添加新开发的模块名：http2，注意http2刚好对应于实现类Http2Module的名字





